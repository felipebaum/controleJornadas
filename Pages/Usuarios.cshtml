@page
@model controleJornadas.Pages.UsuariosModel
using controleJornadas.Models;
using Microsoft.AspNetCore.Identity;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
@{
}

<h1>Lista de Usuários</h1>

<table class="table">
    <thead>
        <tr>
            <th>Nome</th>
            <th>Email</th>
            <th>Status</th>
            <th>Ação</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var user in Pages.UsuariosModel)
        {
            <tr>
                <td>@user.UserName</td>
                <td>@user.Email</td>
                <td>@(user.EmailConfirmed ? "Ativo" : "Inativo")</td>
                <td>
                    @if (!user.EmailConfirmed)
                    {
                        <button class="btn btn-success" onclick="approveUser('@user.Id')">Aprovar</button>
                    }
                    else
                    {
                        <button class="btn btn-danger" onclick="disapproveUser('@user.Id')">Reprovar</button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>


    public class IndexModel : PageModel
    {
        private readonly UserManager<IdentityUser> _userManager;

        public IndexModel(UserManager<IdentityUser> userManager)
        {
            _userManager = userManager;
        }

        public List<IdentityUser> Users { get; set; }

        public void OnGet()
        {
            Users = _userManager.Users.ToList();
        }

        public void OnPostApprove(string userId)
        {
            var user = _userManager.FindByIdAsync(userId).Result;
            if (user != null)
            {
                user.EmailConfirmed = true;
                _userManager.UpdateAsync(user);
            }
            RedirectToPage();
        }

        public void OnPostDisapprove(string userId)
        {
            var user = _userManager.FindByIdAsync(userId).Result;
            if (user != null)
            {
                user.EmailConfirmed = false;
                _userManager.UpdateAsync(user);
            }
            RedirectToPage();
        }
    }
}

<script>
    function approveUser(userId) {
        var confirmation = confirm("Deseja realmente aprovar este usuário?");
        if (confirmation) {
            document.location = '/Usuarios?handler=Approve&userId=' + userId;
        }
    }

    function disapproveUser(userId) {
        var confirmation = confirm("Deseja realmente reprovar este usuário?");
        if (confirmation) {
            document.location = '/Usuarios?handler=Disapprove&userId=' + userId;
        }
    }
</script>
